<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>归宿照片拍摄预约系统</title>
  <style>
    :root{
      --bg:#0b1220;
      --card:#0f172a;
      --border:rgba(148,163,184,.18);
      --text:#e5e7eb;
      --muted:#9ca3af;
      --accent:#60a5fa;
      --danger:#ef4444;
      --shadow:0 14px 40px rgba(0,0,0,.45);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background: radial-gradient(1200px 600px at 20% -10%, rgba(96,165,250,.16), transparent 55%),
                  radial-gradient(900px 500px at 90% 10%, rgba(99,102,241,.12), transparent 50%),
                  var(--bg);
      color:var(--text);
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica Neue,Arial;
      min-height:100vh;
      display:flex;
      justify-content:center;
      padding:34px 16px 48px;
    }
    .wrap{width:min(1100px,100%);}
    .top{
      display:flex;
      justify-content:space-between;
      align-items:center;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--border);
      border-radius: var(--radius);
      padding:18px 18px;
      box-shadow: var(--shadow);
      margin-bottom:18px;
    }
    .brand{line-height:1.1}
    .brand h1{font-size:20px;margin:0 0 6px 0;font-weight:760;letter-spacing:.3px}
    .brand .sub{font-size:12px;color:var(--muted)}
    .btn{
      border:1px solid var(--border);
      background: rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 14px;
      border-radius:14px;
      cursor:pointer;
      transition: .15s transform, .15s background;
      user-select:none;
      font-weight:650;
    }
    .btn:hover{transform: translateY(-1px); background: rgba(255,255,255,.09);}
    .btn.primary{background: rgba(96,165,250,.18); border-color: rgba(96,165,250,.25);}
    .btn.primary:hover{background: rgba(96,165,250,.24);}
    .btn.danger{background: rgba(239,68,68,.16); border-color: rgba(239,68,68,.22);}
    .grid{display:grid;grid-template-columns: 2.2fr 1fr;gap:18px;}
    @media (max-width: 920px){.grid{grid-template-columns:1fr;}}
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid var(--border);
      border-radius: var(--radius);
      padding:18px;
      box-shadow: var(--shadow);
    }
    .card h2{margin:0 0 12px 0;font-size:16px;letter-spacing:.3px}
    .row{display:grid;grid-template-columns: 1fr 1fr;gap:12px;}
    @media (max-width: 680px){ .row{grid-template-columns:1fr;} }
    .field label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px 2px}
    .field input,.field select,.field textarea{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--border);
      background: rgba(10,15,30,.55);
      color:var(--text);
      outline:none;
    }
    .field textarea{min-height:100px;resize:vertical}
    .field input::placeholder,.field textarea::placeholder{color:rgba(156,163,175,.7)}
    .muted{color:var(--muted);font-size:12px}
    .actions{display:flex;gap:10px;align-items:center;margin-top:14px;flex-wrap:wrap}
    .chk{display:flex;gap:10px;align-items:center;margin-top:12px;color:var(--muted);font-size:12px}
    .chk input{width:18px;height:18px}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      padding:8px 10px;border-radius:999px;
      color:var(--muted);font-size:12px;
    }
    .status{margin-top:12px;color:var(--muted);font-size:12px}
    /* modal */
    .mask{position:fixed;inset:0;background: rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:16px;z-index:999;}
    .mask.show{display:flex;}
    .modal{
      width:min(560px,100%);
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
      border:1px solid var(--border);
      border-radius: 18px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modalHead{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;border-bottom:1px solid var(--border);}
    .modalHead strong{font-size:14px;letter-spacing:.2px}
    .modalBody{padding:16px}
    .x{background:transparent;border:0;color:var(--muted);font-size:22px;cursor:pointer;line-height:1}
    .barcodeBox{background:#fff;border-radius:12px;padding:12px;overflow:hidden;}
    .notice{display:flex;gap:10px;align-items:flex-start;background: rgba(255,255,255,.04);border:1px solid var(--border);border-radius:14px;padding:12px;color:var(--muted);font-size:12px;}
    .adminWrap{display:none;}
    .adminTop{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:12px;}
    .adminTop .left{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
    .table{width:100%;border-collapse:separate;border-spacing:0;overflow:hidden;border:1px solid var(--border);border-radius:14px;}
    .table th,.table td{text-align:left;padding:10px 10px;border-bottom:1px solid var(--border);font-size:12px;vertical-align:top;}
    .table th{color:var(--muted);font-weight:650;background: rgba(255,255,255,.03);}
    .table tr:last-child td{border-bottom:none;}
    .tag{display:inline-flex;align-items:center;justify-content:center;padding:4px 8px;border-radius:999px;font-size:12px;border:1px solid var(--border);background: rgba(255,255,255,.04);color:var(--muted);white-space:nowrap;}
    .tag.ok{border-color:rgba(34,197,94,.35);background:rgba(34,197,94,.12);color:#bbf7d0}
    .tag.warn{border-color:rgba(245,158,11,.35);background:rgba(245,158,11,.12);color:#fde68a}
    .tag.gray{border-color:rgba(148,163,184,.25);background:rgba(148,163,184,.08);color:#cbd5e1}
    .tag.done{border-color:rgba(59,130,246,.35);background:rgba(59,130,246,.12);color:#bfdbfe}
    .miniBtn{border:1px solid var(--border);background: rgba(255,255,255,.05);color:var(--text);padding:7px 10px;border-radius:12px;cursor:pointer;font-size:12px;font-weight:650;margin-right:6px;}
    .miniBtn:hover{background: rgba(255,255,255,.08);}
    .miniBtn.danger{border-color:rgba(239,68,68,.25);background: rgba(239,68,68,.14);}
    .miniBtn.danger:hover{background: rgba(239,68,68,.20);}
    footer{margin-top:18px;text-align:center;color:rgba(148,163,184,.6);font-size:12px;}
  </style>
</head>

<body>
<div class="wrap">
  <div class="top">
    <div class="brand">
      <h1>归宿照片拍摄预约系统</h1>
      <div class="sub">Made by Recycle</div>
    </div>
    <button class="btn" id="btnOpenAdmin">管理员登录</button>
  </div>

  <div class="grid">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;">
        <h2>填写信息</h2>
        <span class="pill" id="pillNo">预约编号：—</span>
      </div>

      <div class="row">
        <div class="field">
          <label>游戏昵称 *</label>
          <input id="gameName" placeholder="请输入游戏里的昵称" maxlength="32" />
        </div>
        <div class="field">
          <label>游戏数字ID *</label>
          <input id="gameId" placeholder="仅数字" inputmode="numeric" maxlength="18" />
        </div>
        <div class="field">
          <label>微信昵称 *</label>
          <input id="wxName" placeholder="请输入常用微信昵称" maxlength="32" />
        </div>
        <div class="field">
          <label>手机号 *</label>
          <input id="phone" placeholder="请输入手机号" inputmode="numeric" maxlength="20" />
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div class="field">
          <label>预定归宿 *</label>
          <select id="house">
            <option value="迷雾山庄">迷雾山庄</option>
            <option value="林泉池馆">林泉池馆</option>
            <option value="221B">221B</option>
            <option value="沉默的律师事务所">沉默的律师事务所</option>
            <option value="庄园之声">庄园之声</option>
            <option value="德罗斯小姐的公寓">德罗斯小姐的公寓</option>
          </select>
        </div>
        <div class="field">
          <label>日期 *</label>
          <input id="date" type="date" />
        </div>
        <div class="field">
          <label>拍照主题数 *</label>
          <input id="topicCount" value="1" inputmode="numeric" maxlength="2" />
        </div>
        <div class="field" style="grid-column: 1 / -1;">
          <label>拍照主题 *</label>
          <textarea id="topics" placeholder="请写出与数量对应的拍照主题和你的要求"></textarea>
          <div class="muted" style="margin-top:6px;">提交后将生成预约编号，请自行保存。</div>
        </div>
      </div>

      <div class="chk">
        <input id="agree" type="checkbox" />
        <span>我已阅读并同意《隐私与预约条款》</span>
      </div>

      <div class="actions">
        <button class="btn primary" id="btnSubmit">预约并确认</button>
        <button class="btn" id="btnReset" type="button">重置</button>
        <span class="status" id="guestStatus"></span>
      </div>

      <div style="margin-top:14px;border-top:1px solid var(--border);padding-top:14px;">
        <h2 style="margin:0 0 10px 0;font-size:14px;letter-spacing:.2px;">查询预约</h2>
        <div class="row">
          <div class="field">
            <label>预约编号</label>
            <input id="lookupNo" placeholder="例如：R-XXXXXXXX" maxlength="14" />
          </div>
          <div class="field" style="display:flex;align-items:flex-end;gap:10px;">
            <button class="btn" id="btnLookup" type="button">查询</button>
            <span class="status" id="lookupStatus"></span>
          </div>
        </div>
      </div>
    </div>

    <div>
      <div class="card" style="margin-bottom:18px;">
        <h2>使用说明</h2>
        <div class="notice">
          <div style="margin-top:2px;">•</div>
          <div>
            填写必填信息并选择归宿与日期，提交后将生成预约编号。<br/>
            到店可出示条形码快速核对。
          </div>
        </div>
      </div>
      <div class="card">
        <h2>今日受理状态</h2>
        <div class="muted">客户可正常提交</div>
      </div>
    </div>
  </div>

  <!-- Admin (hidden until login) -->
  <div class="card adminWrap" id="adminWrap" style="margin-top:18px;">
    <div class="adminTop">
      <div class="left">
        <strong style="font-size:14px;">管理端</strong>
        <span class="pill" id="adminUserPill">未登录</span>
      </div>
      <div class="left">
        <input id="adminSearch" placeholder="搜索：编号 / 昵称 / 手机 / 日期" style="width:min(360px,100%);padding:10px 12px;border-radius:14px;border:1px solid var(--border);background:rgba(10,15,30,.55);color:var(--text);"/>
        <select id="adminFilterStatus" style="width:170px;">
          <option value="ALL">全部状态</option>
          <option value="PENDING">待处理</option>
          <option value="CONFIRMED">已确认</option>
          <option value="DONE">已完成</option>
          <option value="REJECTED">已拒绝</option>
          <option value="CANCELED">已取消</option>
        </select>
        <button class="btn" id="btnExport">导出CSV</button>
        <button class="btn danger" id="btnLogout">退出登录</button>
      </div>
    </div>

    <div class="muted" id="adminTip" style="margin-bottom:10px;"></div>

    <div style="overflow:auto;">
      <table class="table" id="adminTable">
        <thead>
          <tr>
            <th style="min-width:120px;">预约编号</th>
            <th style="min-width:90px;">状态</th>
            <th style="min-width:120px;">日期</th>
            <th style="min-width:130px;">归宿</th>
            <th style="min-width:120px;">游戏昵称</th>
            <th style="min-width:110px;">微信昵称</th>
            <th style="min-width:120px;">手机号</th>
            <th style="min-width:90px;">主题数</th>
            <th style="min-width:220px;">主题</th>
            <th style="min-width:220px;">操作</th>
          </tr>
        </thead>
        <tbody id="adminTbody"></tbody>
      </table>
    </div>
  </div>

  <footer>© 2026 归宿照片拍摄预约系统</footer>
</div>

<!-- Success modal -->
<div class="mask" id="successMask" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true">
    <div class="modalHead">
      <strong>预约成功</strong>
      <button class="x" id="btnCloseSuccess" aria-label="关闭">×</button>
    </div>
    <div class="modalBody">
      <div class="muted" style="margin-bottom:10px;">请保存预约编号。到店出示条形码可快速核对。</div>
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:10px;">
        <span class="pill" id="successNo">预约编号：—</span>
        <button class="btn" id="btnCopyNo" type="button">复制编号</button>
      </div>
      <div class="barcodeBox">
        <svg id="barcode"></svg>
      </div>
    </div>
  </div>
</div>

<!-- Admin login modal -->
<div class="mask" id="adminMask" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true">
    <div class="modalHead">
      <strong>管理员登录</strong>
      <button class="x" id="btnCloseAdmin" aria-label="关闭">×</button>
    </div>
    <div class="modalBody">
      <div class="field">
        <label>邮箱</label>
        <input id="adminEmail" placeholder="请输入管理员邮箱" autocomplete="username" />
      </div>
      <div class="field" style="margin-top:10px;">
        <label>密码</label>
        <input id="adminPass" type="password" placeholder="请输入密码" autocomplete="current-password" />
      </div>
      <div class="actions" style="margin-top:14px;">
        <button class="btn primary" id="btnAdminLogin">登录</button>
        <span class="status" id="adminStatus"></span>
      </div>
    </div>
  </div>
</div>

<!-- Lookup modal -->
<div class="mask" id="lookupMask" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true">
    <div class="modalHead">
      <strong>我的预约</strong>
      <button class="x" id="btnCloseLookup" aria-label="关闭">×</button>
    </div>
    <div class="modalBody">
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:10px;">
        <span class="pill" id="lookupNoPill">预约编号：—</span>
        <span class="pill" id="lookupStatusPill">状态：—</span>
      </div>
      <div class="muted" id="lookupInfo" style="margin-bottom:10px;"></div>
      <div class="barcodeBox" style="margin-bottom:10px;">
        <svg id="lookupBarcode"></svg>
      </div>
      <div class="muted">如需修改/取消，请联系管理员处理。</div>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>

<script>
  // Firebase config（保持在代码里即可，不会在页面显示）
  const firebaseConfig = {
    apiKey: "AIzaSyCgMEVgfUTtVArQ-wtg-Il605o80PFhuFE",
    authDomain: "photo-order-6bba4.firebaseapp.com",
    projectId: "photo-order-6bba4",
    storageBucket: "photo-order-6bba4.firebasestorage.app",
    messagingSenderId: "411864836639",
    appId: "1:411864836639:web:50fff0fed782925d4d832a"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const auth = firebase.auth();

  const $ = (id) => document.getElementById(id);
  const show = (el, on=true) => on ? el.classList.add('show') : el.classList.remove('show');
  const safeText = (v) => (v ?? "").toString().trim();

  function genNo(){
    return "R-" + Math.random().toString(36).slice(2, 10).toUpperCase();
  }

  function setStatus(el, msg, ok=null){
    el.textContent = msg || "";
    if(ok === true) el.style.color = "#bbf7d0";
    else if(ok === false) el.style.color = "#fecaca";
    else el.style.color = "var(--muted)";
  }

  function statusTag(status){
    if(status === "PENDING") return '<span class="tag gray">待处理</span>';
    if(status === "CONFIRMED") return '<span class="tag warn">已接受</span>';
    if(status === "DONE") return '<span class="tag done">已完成</span>';
    if(status === "REJECTED") return '<span class="tag danger" style="border-color:rgba(239,68,68,.35);background:rgba(239,68,68,.12);color:#fecaca">已拒绝</span>';
    if(status === "CANCELED") return '<span class="tag" style="border-color:rgba(148,163,184,.35);background:rgba(148,163,184,.10);color:#e5e7eb">已取消</span>';
    return '<span class="tag gray">—</span>';
  }

  functionfunction fmtDate(value){
    if(!value) return "";
    if(typeof value === "string") return value;
    try{
      const d = value.toDate ? value.toDate() : new Date(value);
      if(Number.isNaN(d.getTime())) return "";
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${dd}`;
    }catch(e){ return ""; }
  }

  function csvEscape(s){
    s = (s ?? "").toString();
    if(/[",\n]/.test(s)) return '"' + s.replaceAll('"','""') + '"';
    return s;
  }

  // Guest submit
  const guestStatus = $("guestStatus");
  const pillNo = $("pillNo");

  $("btnReset").addEventListener("click", ()=>{
    $("gameName").value = "";
    $("gameId").value = "";
    $("wxName").value = "";
    $("phone").value = "";
    $("date").value = "";
    $("topicCount").value = "1";
    $("topics").value = "";
    $("agree").checked = false;
    pillNo.textContent = "预约编号：—";
    setStatus(guestStatus, "");
  });

  $("btnSubmit").addEventListener("click", async ()=>{
    setStatus(guestStatus, "正在提交…");
    try{
      const gameName = safeText($("gameName").value);
      const gameId = safeText($("gameId").value);
      const wxName = safeText($("wxName").value);
      const phone = safeText($("phone").value);
      const house = $("house").value;
      const date = $("date").value;
      const topicCount = safeText($("topicCount").value);
      const topics = safeText($("topics").value);
      const agree = $("agree").checked;

      if(!agree) return setStatus(guestStatus, "请先勾选同意条款。", false);
      if(!gameName || !gameId || !wxName || !phone || !house || !date || !topicCount || !topics){
        return setStatus(guestStatus, "请把必填项填写完整。", false);
      }
      if(!/^[0-9]+$/.test(gameId)) return setStatus(guestStatus, "游戏数字ID需为纯数字。", false);
      if(!/^[0-9]+$/.test(topicCount) || Number(topicCount) < 1) return setStatus(guestStatus, "拍照主题数需为≥1的数字。", false);

      const no = genNo();
      const payload = {
        no,
        gameName,
        gameId,
        wxName,
        phone,
        house,
        date,
        topicCount: Number(topicCount),
        topics,
        status: "PENDING",
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      };

      // guest only creates (read is blocked by rules)
      await db.collection("applications").doc(no).set(payload);

      pillNo.textContent = "预约编号：" + no;
      $("successNo").textContent = "预约编号：" + no;

      try{
        JsBarcode("#barcode", no, { format:"CODE128", displayValue:true, fontSize:14, height:70, margin:10 });
      }catch(e){}

      show($("successMask"), true);
      setStatus(guestStatus, "提交成功。", true);

    }catch(err){
      console.error(err);
      setStatus(guestStatus, "提交失败，请稍后重试。", false);
    }
  });

  // Success modal
  $("btnCloseSuccess").addEventListener("click", ()=> show($("successMask"), false));
  $("successMask").addEventListener("click", (e)=>{ if(e.target === $("successMask")) show($("successMask"), false); });
  $("btnCopyNo").addEventListener("click", async ()=>{
    const txt = $("successNo").textContent.replace("预约编号：","").trim();
    try{
      await navigator.clipboard.writeText(txt);
      $("btnCopyNo").textContent = "已复制";
      setTimeout(()=> $("btnCopyNo").textContent = "复制编号", 900);
    }catch(e){
      const ta = document.createElement("textarea");
      ta.value = txt;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      ta.remove();
      $("btnCopyNo").textContent = "已复制";
      setTimeout(()=> $("btnCopyNo").textContent = "复制编号", 900);
    }
  });

  // Lookup (guest: by reservation number)
  const lookupStatus = $("lookupStatus");
  $("btnLookup").addEventListener("click", async ()=>{
    setStatus(lookupStatus, "查询中…");
    const no = safeText($("lookupNo").value).toUpperCase();
    if(!/^R-[A-Z0-9]{8}$/.test(no)){
      return setStatus(lookupStatus, "请输入正确的预约编号。", false);
    }
    try{
      const doc = await db.collection("applications").doc(no).get();
      if(!doc.exists){
        return setStatus(lookupStatus, "未找到该预约编号。", false);
      }
      const a = doc.data() || {};
      $("lookupNoPill").textContent = "预约编号：" + (a.no || no);
      $("lookupStatusPill").textContent = "状态：" + (
        a.status === "PENDING" ? "待处理" :
        a.status === "CONFIRMED" ? "已接受" :
        a.status === "DONE" ? "已完成" :
        a.status === "REJECTED" ? "已拒绝" :
        a.status === "CANCELED" ? "已取消" : "—"
      );
      $("lookupInfo").textContent = `日期：${a.date || ""}  ·  归宿：${a.house || ""}  ·  主题数：${a.topicCount ?? ""}`;
      try{
        JsBarcode("#lookupBarcode", (a.no || no), { format:"CODE128", displayValue:true, fontSize:14, height:70, margin:10 });
      }catch(e){}
      show($("lookupMask"), true);
      setStatus(lookupStatus, "", null);
    }catch(err){
      console.error(err);
      setStatus(lookupStatus, "查询失败，请稍后重试。", false);
    }
  });

  $("btnCloseLookup").addEventListener("click", ()=> show($("lookupMask"), false));
  $("lookupMask").addEventListener("click", (e)=>{ if(e.target === $("lookupMask")) show($("lookupMask"), false); });

  // Admin login
  const adminWrap = $("adminWrap");
  const adminStatus = $("adminStatus");
  const adminTip = $("adminTip");
  const adminTbody = $("adminTbody");
  const adminUserPill = $("adminUserPill");
  let cacheApps = [];

  $("btnOpenAdmin").addEventListener("click", ()=> show($("adminMask"), true));
  $("btnCloseAdmin").addEventListener("click", ()=> show($("adminMask"), false));
  $("adminMask").addEventListener("click", (e)=>{ if(e.target === $("adminMask")) show($("adminMask"), false); });

  $("btnAdminLogin").addEventListener("click", async ()=>{
    setStatus(adminStatus, "登录中…");
    try{
      const email = safeText($("adminEmail").value);
      const pass = $("adminPass").value;
      if(!email || !pass) return setStatus(adminStatus, "请输入邮箱和密码。", false);
      await auth.signInWithEmailAndPassword(email, pass);
      show($("adminMask"), false);
      setStatus(adminStatus, "");
    }catch(err){
      console.error(err);
      setStatus(adminStatus, "登录失败，请检查账号或密码。", false);
    }
  });

  $("btnLogout").addEventListener("click", async ()=>{ await auth.signOut(); });

  auth.onAuthStateChanged(async (user)=>{
    if(user){
      adminUserPill.textContent = "已登录：" + (user.email || "admin");
      adminWrap.style.display = "block";
      adminTip.textContent = "正在加载预约数据…";
      await loadAdminData();
    }else{
      adminUserPill.textContent = "未登录";
      adminWrap.style.display = "none";
      cacheApps = [];
      adminTbody.innerHTML = "";
      adminTip.textContent = "";
    }
  });

  async function loadAdminData(){
    try{
      const snap = await db.collection("applications").orderBy("createdAt","desc").get();
      cacheApps = snap.docs.map(d => d.data());
      adminTip.textContent = `已加载 ${cacheApps.length} 条预约`;
      renderAdminTable();
    }catch(err){
      console.error(err);
      adminTip.textContent = "加载失败：请确认管理员账号权限与 Firestore 规则。";
    }
  }

  function renderAdminTable(){
    const q = safeText($("adminSearch").value).toLowerCase();
    const fs = $("adminFilterStatus").value;

    const rows = cacheApps.filter(a=>{
      const all = [a.no,a.gameName,a.wxName,a.phone,a.date,a.house]
        .map(x=> (x??"").toString().toLowerCase()).join(" ");
      const hit = !q || all.includes(q);
      const hitStatus = (fs === "ALL") || (a.status === fs);
      return hit && hitStatus;
    });

    adminTbody.innerHTML = rows.map(a=>{
      const statusHtml = statusTag(a.status);
      const date = a.date || fmtDate(a.createdAt);
      const safeTopics = (a.topics ?? "").toString().replaceAll("<","&lt;").replaceAll(">","&gt;");
      return `
        <tr data-no="${a.no}">
          <td><strong>${a.no}</strong></td>
          <td>${statusHtml}</td>
          <td>${date || ""}</td>
          <td>${a.house || ""}</td>
          <td>${a.gameName || ""}</td>
          <td>${a.wxName || ""}</td>
          <td>${a.phone || ""}</td>
          <td>${a.topicCount ?? ""}</td>
          <td style="white-space:pre-wrap;">${safeTopics}</td>
          <td>
            <button class="miniBtn" data-act="accept">接受</button>
            <button class="miniBtn" data-act="reject">拒绝</button>
            <button class="miniBtn" data-act="cancel">取消</button>
            <button class="miniBtn" data-act="done">完成</button>
            <button class="miniBtn" data-act="copy">复制编号</button>
            <button class="miniBtn danger" data-act="del">删除</button>
          </td>
        </tr>
      `;
    }).join("");

    if(rows.length === 0){
      adminTbody.innerHTML = `<tr><td colspan="10" class="muted">暂无匹配数据</td></tr>`;
    }
  }

  $("adminSearch").addEventListener("input", ()=> renderAdminTable());
  $("adminFilterStatus").addEventListener("change", ()=> renderAdminTable());

  $("adminTable").addEventListener("click", async (e)=>{
    const btn = e.target.closest("button");
    if(!btn) return;
    const tr = e.target.closest("tr");
    if(!tr) return;
    const no = tr.getAttribute("data-no");
    const act = btn.getAttribute("data-act");
    const item = cacheApps.find(x=> x.no === no);
    if(!item) return;

    if(act === "copy"){
      try{
        await navigator.clipboard.writeText(no);
        btn.textContent = "已复制";
        setTimeout(()=> btn.textContent = "复制编号", 800);
      }catch(e){}
      return;
    }

    if(act === "accept" || act === "reject" || act === "cancel" || act === "done"){
      let ns = item.status || "PENDING";
      if(act === "accept") ns = "CONFIRMED";
      if(act === "reject") ns = "REJECTED";
      if(act === "cancel") ns = "CANCELED";
      if(act === "done") ns = "DONE";

      const old = btn.textContent;
      btn.textContent = "处理中…";
      try{
        await db.collection("applications").doc(no).update({
          status: ns,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        item.status = ns;
        renderAdminTable();
      }catch(err){
        console.error(err);
        btn.textContent = old;
        alert("操作失败：请确认管理员已登录且规则允许更新。");
      }
      return;
    }

    if(act === "del"){
      if(!confirm(`确认删除预约：${no}？该操作不可撤销。`)) return;
      const old = btn.textContent;
      btn.textContent = "删除中…";
      try{
        await db.collection("applications").doc(no).delete();
        cacheApps = cacheApps.filter(x=> x.no !== no);
        renderAdminTable();
        adminTip.textContent = `已加载 ${cacheApps.length} 条预约`;
      }catch(err){
        console.error(err);
        btn.textContent = old;
        alert("删除失败：请确认管理员已登录且规则允许删除。");
      }
      return;
    }
  });

  $("btnExport").addEventListener("click", ()=>{
    if(!auth.currentUser) return alert("请先登录管理员账号。");
    const header = ["no","status","date","house","gameName","gameId","wxName","phone","topicCount","topics","createdAt"];
    const lines = [header.join(",")];
    for(const a of cacheApps){
      const line = [
        a.no, a.status, a.date, a.house, a.gameName, a.gameId, a.wxName, a.phone,
        a.topicCount, a.topics, fmtDate(a.createdAt)
      ].map(csvEscape).join(",");
      lines.push(line);
    }
    const blob = new Blob([lines.join("\n")], {type:"text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "applications.csv";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  });
</script>
</body>
</html>


